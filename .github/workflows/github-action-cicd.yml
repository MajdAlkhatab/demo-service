name: Sync Only Test

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write
  id-token: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4

      # Load PAT from GitHub secrets â†’ into env.PAT
      - name: Load PAT
        run: echo "PAT=${{ secrets.PAT }}" >> $GITHUB_ENV


      - name: Clone & Sync to curamet/demo-service
        env:
          PAT: ${{ env.PAT }}
        run: |
          # Clone target repo
          git clone https://$PAT@github.com/curamet/demo-service.git target-repo
          cd target-repo
          git checkout majd-ci-cd

          # Copy files
          rsync -av --delete ../ . \
            --exclude ".git" \
            --exclude ".github" \
            --exclude "node_modules" || true

          # Git identity
          git config --global user.email "github-actions@curamet.com"
          git config --global user.name "GitHub Actions Bot"

          git add .
          if git diff-index --quiet HEAD; then
            echo "No changes to sync."
            exit 0
          fi

          git commit -m "Auto-sync updates from fork"
          git push https://$PAT@github.com/curamet/demo-service.git HEAD:majd-ci-cd
